# ハラキリ 仕様書 v0.1（機能・非機能）

## 1. 目的

### 1.1 プロダクト目的

* “タスク管理”ではなく、**外部に迷惑・損害が出る締切（ハラキリライン）だけ**を管理する。
* ADHD特性を念頭に、以下を最重要KGIとする：

  * **タスク過多によるパニックを起こしにくくする**
  * **先延ばし（着手困難）を起こりにくくする**

### 1.2 成功の定義（KPI）

* ホーム表示後の **最初のアクション率（5分/連絡/予約）**
* 危険度上昇時（予兆/警告/最終）での **「5分開始率」**
* 締切超過時の **「連絡テンプレ利用率」**（被害最小化）
* 全件一覧閲覧率が高すぎない（＝浴びていない）

---

## 2. 想定ユーザー・前提

### 2.1 想定ユーザー（ビジネス寄り）

* 個人（営業/PM/エンジニア/管理部門など）で、対外締切・社内締切を複数抱える
* “やることが多い”よりも、“落とせない締切がある”ことがストレス源

### 2.2 ADHD配慮の設計原則（仕様に反映する制約）

* **選択肢・情報量を制限**（迷いを減らす）
* **未完了件数など不安を増幅する数値を強調しない**
* “叱る通知”は禁止。通知は **着火（次の一手提示）**に限定
* “あとで”を増やすスヌーズ運用を避け、代わりに **予約（候補3つ）**に統一

---

## 3. 用語定義

* **ライン（Harakiri Line）**：外部・対外的に影響が出る可能性が高い締切事項。管理の最小単位。
* **期日（Due Date）**：約束/提出/支払い等の締切日時（または日付）
* **猶予（Grace / 切腹まで）**：期日を超えても致命傷になるまでの許容（例：+2営業日）。未設定可。
* **切腹まで残り**：`期日 + 猶予` までの残時間（猶予がある場合はこちらを優先）
* **危険度レベル**：ホーム上位表示・通知判定に用いる内部レベル（1〜5）
* **進捗（progress）**：対象ラインで「5分チェックが1つでも完了」した状態

---

## 4. スコープ

### 4.1 MVPに含める

* ラインの登録・編集・完了・保留
* カテゴリ推定・カテゴリ手動変更
* 「5分だけ」チェックリスト自動生成（常に3つ）
* 「連絡で被害を止める」テンプレ生成（一次/延期/助け）
* 危険度レベル計算 → 上位3件提示（内部ロジック）
* 通知（予兆/警告/最終）＋アクション（5分/連絡/予約）
* 期限超過時の「被害最小化」導線（連絡推奨）
* 最小イベントログ（KPI計測）

### 4.2 MVPに含めない（拡張要件）

* チーム共有、タスク分解、ガント、複雑な依存関係
* メール/Slack等への直接送信（MVPはコピー/共有で代替）
* 外部カレンダー自動同期（将来）
* AIによるテンプレ自動文章生成（将来）

---

# 5. データ仕様（主要エンティティ）

## 5.1 ライン（Line）

必須：

* `id`：UUID
* `title`：文字列
* `due_at`：日時 or 日付（実装で統一推奨：日時）
* `counterparty`：文字列（相手/会社/担当）

任意：

* `category`：列挙（10カテゴリ）
* `damage`：列挙（S/A/B/C/D、未設定はB）
* `grace_days`：整数（0以上、未設定可）
* `links[]`：URL配列（0個以上）
* `notes`：自由メモ（短文推奨）

内部状態：

* `status`：`active | done | snoozed_reserved | parked`（MVPでは active/done/parked でも可）
* `progress`：bool（5分チェックが1つでも完了）
* `created_at`, `updated_at`
* `last_action_at`：最終アクション時刻
* `overdue_at`：期限超過判定の基準時刻（due_at or due_at+grace）
* `risk_level`：1〜5（内部算出、保存してもよい）

## 5.2 テンプレ（Template）

* `type`：`contact_primary | contact_delay | ask_help`
* `body`：文字列（プレースホルダ埋め込み後）

## 5.3 チェックリスト（Checklist）

* `line_id`
* `items[3]`：各 `label`, `link?`, `checked_at?`

---

# 6. 機能要件

## 6.1 ライン登録

### 6.1.1 登録フロー要件

* 必須入力は **3項目固定**：`title / due_at / counterparty`
* 登録時に仕分け質問を実施：

  * Q：「遅れると外部に迷惑 or 損害が出る可能性が高い？」（Yes/No）
  * Yes：`active`として保存
  * No：`parked（保留箱）`として保存（通知対象外）

### 6.1.2 カテゴリ推定

* `title`のキーワード辞書でカテゴリ推定（当たらなくても良い）
* 推定結果はユーザーが後から変更できる

### 6.1.3 デフォルト値

* `damage`未設定：B
* `grace_days`未設定：0（またはnull扱い。どちらでもよいが一貫性を持つ）
* `links[]`：空

---

## 6.2 ライン編集

* `title/due_at/counterparty/category/damage/grace/links/notes` を編集可能
* `status`を `active/done/parked` に変更可能（doneは完了）
* `parked`は通知対象外
* `done`は通知対象外・危険度計算対象外

---

## 6.3 上位表示ロジック（危険度レベル）

### 6.3.1 近さの採用規則

* `grace_days > 0` の場合：近さは **切腹まで残り**（`due_at + grace`）
* それ以外：近さは **期日まで残り**（`due_at`）

### 6.3.2 危険度レベル決定

* 近さレベル（例）：

  * 5：今日（残り0日）または期限超過
  * 4：1営業日以内
  * 3：2〜3営業日
  * 2：4〜7日
  * 1：8日以上
* ダメージ補正：

  * S:+2 / A:+1 / B:+0 / C:-1 / D:-2
* 進捗補正：

  * `progress=true`：-1（下限1）
* 合成後、1〜5に丸める

### 6.3.3 上位3件選定

* 対象：`status=active` のみ
* `risk_level`高い順でソートし、上位3件を採用
* 同レベルは「期限が近い」→「ダメージが高い」優先
* 期限超過が多くても **上位3件のみ**（パニック防止）

---

## 6.4 「5分だけ」チェックリスト生成

### 6.4.1 生成仕様

* 常に **3項目固定**で生成
* ユーザーに選択させない
* 生成トリガー：

  * ライン作成時に生成
  * カテゴリ変更時に再生成（既存チェックはどうするか：MVPは初期化で可）

### 6.4.2 リンク紐づけ

* `links[]`が存在する場合：

  * チェック1の「開く」に先頭リンクを紐づける
* ない場合：リンクなしの文言テンプレを使う

### 6.4.3 進捗判定

* 3つのうち **1つでもチェックされたら** `progress=true`
* `progress=true`は危険度補正（-1）に反映

---

## 6.5 「連絡で被害を止める」テンプレ生成

### 6.5.1 テンプレ種別（固定）

* 一次連絡（状況共有）
* 延期提案（代替案つき）
* 助けを求める（社内）

### 6.5.2 生成仕様

* カテゴリごとに固定テンプレ本文を持つ（前ターンで作成した文面を採用）
* プレースホルダを埋める：

  * `{相手}` ← counterparty
  * `{ライン名}` ← title
  * `{期日}` ← due_at
  * `{新しい期日}` ← 自動候補（後述）
  * `{提出予定日/時刻}` ← 自動候補（後述）
* 送信はMVPでは「コピー」「共有」で代替（アプリ内送信は拡張）

### 6.5.3 自動候補（先延ばし抑制のためユーザー入力させない）

* `{提出予定時刻}`：デフォルトは「当日終業1時間前」等の規則
* `{新しい期日}`：候補3つを自動生成

  * +1営業日 / +2営業日 / 次週同曜（時間は同時刻）

---

## 6.6 通知（予兆/警告/最終）

### 6.6.1 通知目的

* 罪悪感を煽らず **次の一手（5分 or 連絡）**へ誘導する
* 通知連投は禁止（回避行動の学習を防ぐ）

### 6.6.2 発火条件

* **予兆**：危険度レベルが3になった瞬間（初回のみ）
* **警告**：危険度レベルが4になった瞬間（初回のみ）
* **最終**：危険度レベルが5になった瞬間（初回のみ）＋期限超過後の翌営業日朝に1回のみ

### 6.6.3 通知アクション

* 予兆：`5分だけ` / `連絡` / `着手を予約`
* 警告：`一次連絡` / `延期提案`
* 最終：`連絡`（可能なら `パニックモード` への導線も）

### 6.6.4 再通知ルール

* 同一段階は原則1回のみ
* 例外は最終のみ（翌営業日朝に1回だけ）

---

## 6.7 予約（“あとで”の代替）

### 6.7.1 予約作成

* 予兆通知からのみ作成可能（MVP）
* 候補は3つ固定（ユーザーに時刻入力させない）：

  * `今から` / `昼休み` / `終業前`
* 予約時刻に「5分だけ」通知を **1回だけ**送る

### 6.7.2 予約無視時の挙動

* 予約通知を無視しても追撃しない
* 罪悪感を煽らない固定文言を使用（UI/通知）

---

## 6.8 期限超過時の扱い（被害最小化モード）

* 期限超過ラインは危険度レベル5相当
* 上位3件表示制限は維持
* 期限超過ラインは「連絡」テンプレを最優先導線にする（5分は副次）

---

## 6.9 保留箱（parked）

* `parked`は通知対象外
* `active`へ戻した瞬間に危険度計算を再評価し、必要なら予兆通知対象になる

---

## 6.10 設定

MVPで必要最低限：

* 通知のオン/オフ
* 通知の静かモード（予兆のみ/全部）※実装簡略のため「全部」でも良い
* 営業日/休日判定（日本の祝日まではMVP非対応可。最低でも土日除外の“営業日近似”を用意）

---

## 6.11 ログ（イベント計測）

最小イベント（KPI計測用）：

* `open_home`
* `tap_5min_start`
* `checklist_item_checked`
* `finish_today`
* `tap_contact`
* `copy_template`
* `share_template`
* `tap_schedule`
* `notification_fired_{stage}`
* `line_overdue_shown`
* `tap_panic`（パニック導線がある場合）

ログには本文（テンプレ内容）を含めない（プライバシー）。

---

# 7. 非機能要件

## 7.1 パフォーマンス

* ホーム表示は体感 **即時**（ローカルDB前提で100ms〜数百ms目標）
* 危険度計算はホーム表示時に間に合うこと（ライン数が多くても上位3抽出が遅延しない）

## 7.2 可用性・信頼性

* ローカル保存（オフライン動作）を前提とし、ネットワーク非依存で主要機能が動作する
* 通知スケジュールはOS依存だが、アプリ再起動・端末再起動後も復元される設計を優先

## 7.3 データ保護・セキュリティ

* 端末内データはOSの暗号化領域（Keychain/Keystore等）・DB暗号化（可能なら）を検討
* ログに機密情報（相手名、本文）は送らない/保存しない
* 共有（Share）利用時の誤送信を防ぐため、本文はユーザーが最終確認できる形（OS共有シート）で提供

## 7.4 プライバシー

* テンプレ本文・メモの外部送信はユーザー操作に限定
* アナリティクスは最小限（イベント名と匿名ID）に留める

## 7.5 アクセシビリティ（ADHD含む認知負荷対策）

* 情報量制限：上位3件、チェック3つ、連絡タブ3つを仕様として固定
* 色だけに依存しない（危険状態はテキストも併記）
* 文言は短文・肯定形中心（責めない）

## 7.6 国際化・ローカライズ

* MVPは日本語固定でも可
* 日付・時刻はロケール対応可能な実装にしておく（拡張）

## 7.7 保守性・拡張性

* カテゴリ別テンプレとチェックリストは **データ駆動（設定ファイル/テーブル）**で差し替え可能にする
* 危険度閾値（近さレベル）は設定で調整できる構造が望ましい（A/Bテストも視野）

## 7.8 エラーハンドリング

* 期限や相手が未入力の場合、保存不可（必須3項目）
* 通知権限がない場合は、権限誘導を出しつつアプリ内は動作する

---

# 8. 受け入れ基準（MVPのDone定義）

* ラインを作成でき、上位3件が危険度に従って選ばれる
* 5分チェックがカテゴリに応じて自動生成され、1つチェックで progress になる
* 連絡テンプレが3種生成され、コピー/共有できる
* 危険度レベルが3/4/5に到達した瞬間に、各通知が1回だけ発火する
* 予兆通知から予約でき、予約時刻に1回だけ通知が発火する
* 期限超過時に「最終（被害最小化）」が翌営業日朝に1回だけ発火する
* イベントログが本文なしで取得できる
